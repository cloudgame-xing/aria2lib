name: build

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  release:
    types: [published]

  workflow_dispatch:

permissions:
  contents: write
  
jobs:
  build-win-x64:
    runs-on: windows-2025

    steps:
      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          update: true
          install: >-
            make
            base-devel
            pkgconf
            tree
            autoconf
            automake
            autotools
            gettext-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-libssh2
            mingw-w64-x86_64-c-ares

      - name: Force LF on checkout (git config)
        shell: pwsh
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf
          git config --global core.safecrlf true

      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Compile aria2
        shell: msys2 {0}
        run: |
          gcc -v
          export OUT_DIR="$PWD/out/aria2/win-x64"
          pushd aria2
          autoreconf -i
          ./configure --prefix="$OUT_DIR" --without-included-gettext --disable-nls --with-libcares --without-gnutls --without-openssl --with-sqlite3 --without-libxml2 --with-libexpat --with-libz --with-libgmp --with-libssh2 --without-libgcrypt --without-libnettle --enable-libaria2 ARIA2_STATIC=yes
          make -j
          make install
          popd
          echo "output directory structure"
          tree "$OUT_DIR"
          echo "packaging artifact"
          pwd
          tar -czvf aria2-windows-x64.tar.gz -C out aria2/win-x64

      - name: Compile aria2_c_api
        shell: msys2 {0}
        run: |
          cmake --preset debug
          cmake --build --preset debug
          cmake --install build/Debug
          cmake --preset release
          cmake --build --preset release
          cmake --install build/Release --strip
          tar -czvf aria2_c_api-windows-x64.tar.gz -C out aria2lib

      - name: Compile aria2_c_api
        shell: msys2 {0}
        run: |
          cmake --preset debug
          cmake --build --preset debug
          cmake --install build/Debug
          cmake --preset release
          cmake --build --preset release
          cmake --install build/Release --strip
          tar -czvf aria2_c_api-windows-x64.tar.gz -C out aria2lib/win-x64

      - name: Upload to Artifacts (for non-release builds)
        if: github.event_name != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-${{ steps.version.outputs.VERSION }}
          path: |
            aria2-windows-x64.tar.gz
            aria2_c_api-windows-x64.tar.gz
          retention-days: 30
          if-no-files-found: error

      - name: Upload to Release Assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            aria2-windows-x64.tar.gz
            aria2_c_api-windows-x64.tar.gz
          fail_on_unmatched_files: true


  build-linux-x64:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Compile aria2
        shell: bash {0}
        run: |
          export OUT_DIR="$PWD/out/aria2/linux-x64"
          mkdir -p "$OUT_DIR"
          uname -a > "$OUT_DIR/fake.txt"
          gcc -v >> "$OUT_DIR/fake.txt"
          echo "output directory structure"
          tree "$OUT_DIR"
          echo "packaging artifact"
          pwd
          tar -czvf aria2-linux-x64.tar.gz -C out aria2/linux-x64

      - name: Upload to Artifacts (for non-release builds)
        if: github.event_name != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-${{ steps.version.outputs.VERSION }}
          path: |
            aria2-linux-x64.tar.gz
          retention-days: 30
          if-no-files-found: error

      - name: Upload to Release Assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            aria2-linux-x64.tar.gz
          fail_on_unmatched_files: true

  build-macos-arm64:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Compile aria2
        shell: bash {0}
        run: |
          export OUT_DIR="$PWD/out/aria2/macos-arm64"
          mkdir -p "$OUT_DIR"
          uname -a > "$OUT_DIR/fake.txt"
          clang -v >> "$OUT_DIR/fake.txt"
          echo "output directory structure"
          tree "$OUT_DIR"
          echo "packaging artifact"
          pwd
          tar -czvf aria2-macos-arm64.tar.gz -C out aria2/macos-arm64

      - name: Upload to Artifacts (for non-release builds)
        if: github.event_name != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-${{ steps.version.outputs.VERSION }}
          path: |
            aria2-macos-arm64.tar.gz
          retention-days: 30
          if-no-files-found: error

      - name: Upload to Release Assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            aria2-macos-arm64.tar.gz
          fail_on_unmatched_files: true
