name: release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    uses: ./.github/workflows/_build-common.yaml

  publish:
    needs: build
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Download artifacts from build jobs
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create/Update GitHub Release and upload assets
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          tag="${GITHUB_REF_NAME}"

          if ! gh release view "$tag" >/dev/null 2>&1; then
            gh release create "$tag" \
              --title "$tag" \
              --notes "Automated release for $tag"
          fi

          gh release upload "$tag" artifacts/** --clobber